<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head th:replace="fragments/layout :: head(title='Assistant IA | TravelAppV2')">
    <title>Assistant IA | TravelAppV2</title>
</head>
<body>
    <!-- Navigation -->
    <nav th:replace="fragments/layout :: navbar"></nav>
    
    <!-- Alertes -->
    <div th:replace="fragments/layout :: alerts"></div>
    
    <div class="container my-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0"><i class="fas fa-robot me-2"></i> Assistant de Voyage</h3>
                        <p class="mb-0">Posez vos questions sur les voyages et obtenez des r√©ponses personnalis√©es</p>
                    </div>
                    <div class="card-body">
                        <div id="chatContainer" style="height: 60vh; overflow-y: auto; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6; padding: 20px; margin-bottom: 20px;">
                            <!-- Message de bienvenue initial -->
                            <div class="d-flex mb-3">
                                <div style="background-color: #e9ecef; color: #212529; border-radius: 18px; border-bottom-left-radius: 5px; padding: 10px 15px; max-width: 80%;">
                                    <div>Bonjour ! Je suis votre assistant de voyage virtuel. Comment puis-je vous aider aujourd'hui ?</div>
                                    <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 5px; text-align: right;">Maintenant</div>
                                </div>
                            </div>
                        </div>
                        
                        <form id="chatForm" class="mb-3">
                            <div class="input-group">
                                <input type="text" id="userInput" class="form-control" placeholder="Posez votre question sur les voyages..." required>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> Envoyer
                                </button>
                            </div>
                        </form>
                        
                        <div>
                            <p><strong>Exemples de questions :</strong></p>
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                <button class="btn btn-sm btn-outline-primary example-btn">Que faire √† Paris ?</button>
                                <button class="btn btn-sm btn-outline-primary example-btn">Quel budget pr√©voir pour l'Italie ?</button>
                                <button class="btn btn-sm btn-outline-primary example-btn">Quand partir au Japon ?</button>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-sm btn-outline-primary example-btn">Comment planifier un voyage ?</button>
                                <button class="btn btn-sm btn-outline-primary example-btn">Voyager en famille</button>
                                <button class="btn btn-sm btn-outline-primary example-btn">Conseils de s√©curit√©</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer th:replace="fragments/layout :: footer"></footer>
    
    <!-- Scripts -->
    <div th:replace="fragments/layout :: scripts"></div>
    
    <!-- Script du chatbot -->
    <script th:inline="javascript">
        // √âl√©ments du DOM
        const chatContainer = document.getElementById('chatContainer');
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');
        const exampleButtons = document.querySelectorAll('.example-btn');

        // Base de connaissances pour les r√©ponses du chatbot
        const knowledgeBase = {
            // Destinations populaires
            paris: {
                keywords: ["paris", "france", "tour eiffel", "louvre"],
                response: "Paris est une destination magnifique ! Voici mes recommandations :\n\n" +
                    "üèõÔ∏è **√Ä voir absolument** :\n" +
                    "- La Tour Eiffel (r√©servez vos billets en ligne pour √©viter les files)\n" +
                    "- Le mus√©e du Louvre (pr√©voyez au moins une demi-journ√©e)\n" +
                    "- Notre-Dame (vue de l'ext√©rieur pendant sa reconstruction)\n" +
                    "- Le Sacr√©-C≈ìur et Montmartre\n" +
                    "- Les Champs-√âlys√©es et l'Arc de Triomphe\n\n" +
                    "üçΩÔ∏è **Gastronomie** : Ne manquez pas les croissants, macarons, fromages, et un repas dans un bistrot traditionnel.\n\n" +
                    "‚è∞ **Quand y aller** : Avril-Juin ou Septembre-Octobre pour moins de touristes et un temps agr√©able.\n\n" +
                    "üí° **Conseil** : Achetez la Paris Museum Pass si vous comptez visiter plusieurs sites touristiques."
            },
            rome: {
                keywords: ["rome", "italie", "vatican", "colis√©e", "colisee", "pasta", "pizza"],
                response: "L'Italie est une destination riche en histoire, culture et gastronomie ! Pour Rome, voici mes conseils :\n\n" +
                    "üèõÔ∏è **Sites incontournables** :\n" +
                    "- Le Colis√©e et le Forum Romain (achetez un billet combin√©)\n" +
                    "- Le Vatican avec la basilique Saint-Pierre et les mus√©es du Vatican\n" +
                    "- La fontaine de Trevi (visitez t√¥t le matin pour √©viter la foule)\n" +
                    "- Le Panth√©on\n" +
                    "- La place Navone\n\n" +
                    "üçï **Gastronomie** : Go√ªtez aux p√¢tes carbonara authentiques, la pizza romana, les gelati et un vrai espresso italien.\n\n" +
                    "‚è∞ **Quand y aller** : Avril-Mai ou Septembre-Octobre pour √©viter la chaleur estivale intense.\n\n" +
                    "üí° **Conseil** : Portez des chaussures confortables, Rome se d√©couvre √† pied !"
            },
            japon: {
                keywords: ["japon", "tokyo", "kyoto", "sushi", "cerisiers", "sakura"],
                response: "Le Japon offre un m√©lange fascinant entre tradition et modernit√© ! Voici mes recommandations :\n\n" +
                    "üóº **√Ä Tokyo** :\n" +
                    "- Le quartier √©lectronique d'Akihabara\n" +
                    "- Le sanctuaire Meiji et ses jardins\n" +
                    "- La Tokyo Skytree pour une vue panoramique\n" +
                    "- Les quartiers de Shibuya et Shinjuku\n\n" +
                    "‚õ©Ô∏è **√Ä Kyoto** :\n" +
                    "- Le temple Kinkaku-ji (Pavillon d'or)\n" +
                    "- La for√™t de bambous d'Arashiyama\n" +
                    "- Le sanctuaire Fushimi Inari et ses milliers de torii\n" +
                    "- Le quartier de Gion pour apercevoir des geishas\n\n" +
                    "üç± **Gastronomie** : Sushis, ramens, tempuras, okonomiyaki, takoyaki... chaque r√©gion a ses sp√©cialit√©s !\n\n" +
                    "‚è∞ **Quand y aller** :\n" +
                    "- Mars-Avril pour les cerisiers en fleur (r√©servez longtemps √† l'avance)\n" +
                    "- Octobre-Novembre pour les couleurs d'automne\n\n" +
                    "üí° **Conseil** : Achetez un Japan Rail Pass avant votre arriv√©e si vous comptez voyager entre plusieurs villes."
            },
            newyork: {
                keywords: ["new york", "nyc", "manhattan", "√©tats-unis", "etats-unis", "usa"],
                response: "New York est une ville vibrante et cosmopolite ! Voici mes recommandations :\n\n" +
                    "üèôÔ∏è **√Ä voir absolument** :\n" +
                    "- L'Empire State Building ou le Top of the Rock pour une vue panoramique\n" +
                    "- Central Park (pr√©voyez au moins une demi-journ√©e pour l'explorer)\n" +
                    "- Times Square, surtout impressionnant de nuit\n" +
                    "- Le mus√©e MoMA pour l'art moderne\n" +
                    "- La High Line, un parc sur√©lev√© sur une ancienne voie ferr√©e\n" +
                    "- Le m√©morial du 11 septembre\n\n" +
                    "üçî **Gastronomie** : Essayez un bagel new-yorkais, une pizza √† la new-yorkaise, un hot dog de rue et visitez les food courts comme Chelsea Market.\n\n" +
                    "‚è∞ **Quand y aller** : Avril-Juin ou Septembre-Novembre pour un climat agr√©able.\n\n" +
                    "üí° **Conseil** : Achetez un New York CityPASS si vous pr√©voyez de visiter plusieurs attractions touristiques."
            },

            // Cat√©gories de voyage
            budget: {
                keywords: ["budget", "co√ªt", "cout", "prix", "cher", "√©conomique", "economique", "combien"],
                response: "Le budget voyage varie consid√©rablement selon plusieurs facteurs :\n\n" +
                    "üí∞ **Par r√©gion du monde (budget quotidien moyen par personne)** :\n" +
                    "- **Asie du Sud-Est** : 30-70‚Ç¨ (petit budget), 70-120‚Ç¨ (confort)\n" +
                    "- **Europe de l'Est** : 50-80‚Ç¨ (petit budget), 80-150‚Ç¨ (confort)\n" +
                    "- **Europe de l'Ouest** : 80-120‚Ç¨ (petit budget), 120-250‚Ç¨ (confort)\n" +
                    "- **Am√©rique du Nord** : 100-150‚Ç¨ (petit budget), 150-300‚Ç¨ (confort)\n" +
                    "- **Japon/Australie** : 100-150‚Ç¨ (petit budget), 150-300‚Ç¨ (confort)\n\n" +
                    "üìä **R√©partition typique** :\n" +
                    "- H√©bergement : 30-40% du budget\n" +
                    "- Nourriture : 20-25%\n" +
                    "- Transport local : 15-20%\n" +
                    "- Activit√©s et visites : 10-15%\n" +
                    "- Divers (souvenirs, achats) : 5-10%\n\n" +
                    "üí° **Conseils pour √©conomiser** :\n" +
                    "- Voyagez hors saison\n" +
                    "- R√©servez vols et h√©bergements √† l'avance\n" +
                    "- Utilisez les transports en commun\n" +
                    "- Cuisinez quelques repas vous-m√™me\n" +
                    "- Cherchez les attractions gratuites ou √† prix r√©duit"
            },
            planification: {
                keywords: ["planifier", "organiser", "pr√©paration", "preparation", "planification", "plan", "itin√©raire", "itineraire"],
                response: "Pour bien planifier votre voyage, voici une m√©thode en plusieurs √©tapes :\n\n" +
                    "üåç **3-6 mois avant le d√©part** :\n" +
                    "1. Recherche et inspiration : D√©finissez le type d'exp√©rience recherch√©e\n" +
                    "2. Budget et dur√©e : √âtablissez votre budget total et la dur√©e id√©ale\n" +
                    "3. Documentation : V√©rifiez passeport, visa, vaccins n√©cessaires\n" +
                    "4. Transport : R√©servez vos billets d'avion (2-3 mois √† l'avance pour les meilleurs prix)\n\n" +
                    "üè® **1-3 mois avant** :\n" +
                    "5. H√©bergement : R√©servez selon votre style de voyage et budget\n" +
                    "6. Itin√©raire : Planifiez un itin√©raire r√©aliste avec temps de repos\n" +
                    "7. Assurance : Souscrivez √† une assurance voyage adapt√©e\n\n" +
                    "üß≥ **Derni√®res semaines** :\n" +
                    "8. T√©l√©chargez applications utiles (maps hors-ligne, traducteur)\n" +
                    "9. Faites une liste de bagages\n" +
                    "10. Informez votre banque de vos d√©placements\n" +
                    "11. Faites des copies de vos documents importants\n\n" +
                    "üí° **Conseil** : Gardez une journ√©e flexible tous les 3-4 jours dans votre itin√©raire !"
            },
            meteo: {
                keywords: ["m√©t√©o", "meteo", "climat", "saison", "quand visiter", "p√©riode", "periode", "quand partir"],
                response: "La m√©t√©o est un facteur essentiel pour r√©ussir votre voyage. Voici un guide par r√©gion :\n\n" +
                    "üåç **Europe** :\n" +
                    "- **M√©diterran√©e** : Mai-Juin et Septembre-Octobre sont id√©aux (chaud mais pas caniculaire, moins de touristes)\n" +
                    "- **Europe du Nord** : Juin-Ao√ªt offrent les meilleures conditions (temp√©ratures douces, longues journ√©es)\n" +
                    "- **Europe Centrale** : Mai-Septembre pour un temps agr√©able (avec juillet-ao√ªt parfois chaud et bond√©)\n\n" +
                    "üåè **Asie** :\n" +
                    "- **Asie du Sud-Est** : Novembre-F√©vrier (saison s√®che), √©vitez Mai-Octobre (mousson)\n" +
                    "- **Japon** : Mars-Avril (cerisiers en fleur) et Octobre-Novembre (couleurs d'automne)\n" +
                    "- **Inde** : Octobre-Mars (√©vitez la mousson de Juin-Septembre et la chaleur d'Avril-Mai)\n\n" +
                    "üåé **Am√©rique** :\n" +
                    "- **USA/Canada** : Mai-Juin et Septembre-Octobre pour la plupart des r√©gions\n" +
                    "- **Mexique/Cara√Øbes** : D√©cembre-Avril (saison s√®che), √©vitez Septembre-Octobre (ouragans)\n" +
                    "- **Am√©rique du Sud** : Variable selon la r√©gion (le Br√©sil est id√©al d'Avril √† Octobre)\n\n" +
                    "üí° **Conseil** : V√©rifiez la m√©t√©o locale juste avant votre d√©part pour ajuster vos bagages."
            },
            securite: {
                keywords: ["s√©curit√©", "securite", "danger", "risque", "vol", "arnaque", "pickpocket"],
                response: "La s√©curit√© est primordiale en voyage. Voici des conseils essentiels :\n\n" +
                    "üìã **Avant de partir** :\n" +
                    "- Consultez les conseils aux voyageurs officiels de votre gouvernement\n" +
                    "- Souscrivez une assurance voyage compl√®te (m√©dicale, rapatriement, annulation)\n" +
                    "- Enregistrez-vous aupr√®s de votre ambassade si vous voyagez dans une zone √† risque\n" +
                    "- Faites des copies num√©riques de vos documents importants (passeport, assurance, billets)\n\n" +
                    "üîí **S√©curit√© personnelle** :\n" +
                    "- Restez vigilant dans les zones touristiques et transports en commun (pickpockets)\n" +
                    "- Utilisez un portefeuille discret sous vos v√™tements pour l'argent et documents importants\n" +
                    "- √âvitez d'afficher des objets de valeur (bijoux, appareils √©lectroniques co√ªteux)\n" +
                    "- M√©fiez-vous des arnaques courantes ciblant les touristes\n\n" +
                    "ü©∫ **Sant√©** :\n" +
                    "- V√©rifiez les vaccins requis ou recommand√©s\n" +
                    "- Emportez une trousse de premiers soins et vos m√©dicaments habituels\n" +
                    "- Dans certaines r√©gions, buvez uniquement de l'eau en bouteille scell√©e\n" +
                    "- Notez les num√©ros d'urgence locaux et l'adresse de l'h√¥pital le plus proche\n\n" +
                    "üí° **Conseil** : √âcoutez votre intuition. Si une situation vous semble suspecte, √©loignez-vous."
            },
            famille: {
                keywords: ["famille", "enfant", "b√©b√©", "bebe", "ado", "adolescent"],
                response: "Pour un voyage r√©ussi en famille, voici mes recommandations :\n\n" +
                    "üèñÔ∏è **Destinations id√©ales pour les familles** :\n" +
                    "- **Espagne** : Costa Dorada avec PortAventura World, √Æles Canaries\n" +
                    "- **France** : C√¥te d'Azur, Disneyland Paris, Puy du Fou\n" +
                    "- **Royaume-Uni** : Londres avec ses mus√©es gratuits et nombreuses activit√©s pour enfants\n" +
                    "- **Italie** : Lacs du Nord, c√¥tes avec plages √† pente douce\n" +
                    "- **Tha√Ølande** : Plages s√©curitaires, population accueillante envers les enfants\n\n" +
                    "‚úÖ **Conseils pratiques** :\n" +
                    "- Pr√©voyez des trajets plus courts et des pauses r√©guli√®res\n" +
                    "- R√©servez des h√©bergements adapt√©s aux familles avec cuisinette\n" +
                    "- Emportez des divertissements pour les temps d'attente et les trajets\n" +
                    "- Alternez les activit√©s pour plaire √† tous les √¢ges\n" +
                    "- Gardez une routine minimale pour les repas et le sommeil\n\n" +
                    "üß≥ **√Ä ne pas oublier** :\n" +
                    "- Trousse de premiers soins adapt√©e aux enfants\n" +
                    "- Documents n√©cessaires pour voyager avec des mineurs\n" +
                    "- Encas et bouteilles d'eau pour les impr√©vus\n\n" +
                    "üí° **Conseil** : Impliquez les enfants dans la planification du voyage pour qu'ils se sentent investis !"
            }
        };

        // Formatage du texte pour l'affichage
        function formatText(text) {
            // Gras
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Italique
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            // Sauts de ligne
            text = text.replace(/\n/g, '<br>');
            // Emojis (d√©j√† en Unicode, pas besoin de remplacement)
            return text;
        }

        // Ajout d'un message dans la conversation
        function addMessage(content, isUser = false) {
            // Cr√©er l'√©l√©ment de message
            const messageDiv = document.createElement('div');
            messageDiv.className = 'd-flex mb-3' + (isUser ? ' justify-content-end' : '');
            
            // Style diff√©rent selon l'exp√©diteur
            const messageStyle = isUser 
                ? 'background-color: #007bff; color: white; border-radius: 18px; border-bottom-right-radius: 5px; padding: 10px 15px; max-width: 80%;'
                : 'background-color: #e9ecef; color: #212529; border-radius: 18px; border-bottom-left-radius: 5px; padding: 10px 15px; max-width: 80%;';
            
            // Contenu du message
            const content_formatted = isUser ? content : formatText(content);
            
            // Construire le HTML du message
            messageDiv.innerHTML = `
                <div style="${messageStyle}">
                    <div>${content_formatted}</div>
                    <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 5px; text-align: right;">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            
            // Ajouter le message au conteneur
            chatContainer.appendChild(messageDiv);
            
            // Faire d√©filer vers le bas pour voir le nouveau message
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Cr√©ation d'un indicateur de frappe
        function createTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'd-flex mb-3';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <div style="background-color: #e9ecef; border-radius: 18px; padding: 10px 15px; max-width: 80%;">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            return typingDiv;
        }

        // G√©n√©ration d'une r√©ponse bas√©e sur le message utilisateur
        function generateResponse(message) {
            // Conversion en minuscules pour faciliter la comparaison
            const lowerMessage = message.toLowerCase();
            
            // Parcours de la base de connaissances pour trouver une correspondance
            for (const [topic, data] of Object.entries(knowledgeBase)) {
                for (const keyword of data.keywords) {
                    if (lowerMessage.includes(keyword)) {
                        return data.response;
                    }
                }
            }
            
            // Message par d√©faut si aucune correspondance n'est trouv√©e
            return "Merci pour votre question ! Pour vous aider au mieux, pourriez-vous me poser une question sur :\n\n" +
                "- Une destination sp√©cifique (Paris, Rome, Japon, New York...)\n" +
                "- Le budget de voyage\n" +
                "- La planification d'un voyage\n" +
                "- La m√©t√©o et les meilleures p√©riodes\n" +
                "- Les conseils de s√©curit√©\n" +
                "- Les voyages en famille";
        }

        // Traitement de l'envoi du message
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = userInput.value.trim();
            if (!message) return;
            
            // Affichage du message utilisateur
            addMessage(message, true);
            
            // Effacement du champ de saisie
            userInput.value = '';
            
            // Affichage de l'indicateur de frappe
            const typingIndicator = createTypingIndicator();
            
            // Simulation d'un d√©lai de r√©ponse pour un effet naturel
            setTimeout(() => {
                // Suppression de l'indicateur de frappe
                typingIndicator.remove();
                
                // G√©n√©ration et affichage de la r√©ponse
                const response = generateResponse(message);
                addMessage(response);
            }, 1500);
        });

        // Gestion des exemples de questions
        exampleButtons.forEach(button => {
            button.addEventListener('click', function() {
                const question = this.textContent;
                userInput.value = question;
                chatForm.dispatchEvent(new Event('submit'));
            });
        });

        // Style pour les animations d'indicateur de frappe
        const styleSheet = document.createElement("style");
        styleSheet.textContent = `
            .typing-indicator {
                display: inline-block;
                width: 50px;
                height: 20px;
            }
            .typing-indicator span {
                display: inline-block;
                width: 8px;
                height: 8px;
                background-color: #999;
                border-radius: 50%;
                margin-right: 3px;
                animation: typing 1.4s infinite ease-in-out both;
            }
            .typing-indicator span:nth-child(1) { animation-delay: 0s; }
            .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
            .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
            @keyframes typing {
                0% { transform: translateY(0); }
                50% { transform: translateY(-10px); }
                100% { transform: translateY(0); }
            }
        `;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>
